# ニコニコメドレー楽曲アノテーション プレイヤー 要件定義書

## 1. プロジェクト概要

### 1.1 目的
ニコニコ動画の埋め込みプレイヤーAPIを活用し、ニコニコメドレーにおける楽曲アノテーション（いつどの楽曲が使われているか）を視覚的にわかりやすく表示するプレイヤーを開発する。ユーザーが直感的に各楽曲セクションを把握し、特定の楽曲部分に簡単にジャンプできる機能を提供する。

### 1.2 対象ユーザー
- ニコニコメドレーの視聴者
- 特定の楽曲セクションにアクセスしたいユーザー
- 音楽クリエイターやメドレー制作者
- 楽曲分析に興味のあるユーザー

## 2. 機能要件

### 2.1 基本プレイヤー機能
- **動画IDによる読み込み**
  - ユーザーが動画ID（例：sm9）を入力できるフォームを提供
  - 「表示」ボタンクリックで指定したメドレー動画をロード
  - プレイヤー上に現在の動画情報を表示

- **埋め込みプレイヤーの表示**
  - ニコニコ動画の埋め込みプレイヤーをiframeで表示
  - レスポンシブなサイズ調整（アスペクト比維持）
  - プレイヤー読み込み中の視覚的フィードバック

### 2.2 再生制御機能
- **再生/一時停止制御**
  - 明確に視認できる再生/一時停止ボタンの実装
  - 動画領域クリックによる再生/一時停止の切り替え
  - 現在の再生状態を視覚的に表示（アイコン変更）

- **再生位置の同期と操作**
  - シークバーによる再生位置の視覚的表示
  - ドラッグ操作による任意位置へのシーク
  - 現在の再生時間と総再生時間の表示（MM:SS形式）
  - タイムコードマーカーの表示（一定間隔）

- **音量調整**
  - スライダーによる音量調整（0-100%）
  - ミュートボタンの実装
  - 現在の音量レベルの視覚的表示

- **フルスクリーン表示**
  - フルスクリーンモードの切り替えボタン
  - フルスクリーン状態の視覚的フィードバック

### 2.3 楽曲アノテーション機能
- **楽曲セクションタイムライン**
  - 動画全体の再生バー上に楽曲セクションを視覚的に表示
  - 各楽曲に異なる色を割り当てて視覚的に区別
  - 楽曲セクション上にマウスホバーで曲名、アーティスト名をツールチップ表示

- **楽曲ジャンプ機能**
  - セクションをクリックして特定の楽曲の開始位置にジャンプ
  - 人気曲や特徴的なセクションへのクイックジャンプボタン
  - 楽曲リストからの選択とジャンプ機能

- **現在再生中の楽曲ハイライト**
  - 再生中の現在の楽曲セクションを視覚的にハイライト表示
  - 現在再生中の曲名、アーティスト名、開始時間を表示
  - 楽曲切り替わり時の視覚的通知（オプション）

- **コード進行表示** [オプション]
  - 楽曲のコード進行をタイムライン上に表示
  - コードセクションの色分け表示
  - 現在演奏中のコードのハイライト表示

### 2.4 メドレー情報表示
- **楽曲リスト表示**
  - メドレーに含まれる全楽曲のリスト表示
  - 各楽曲の情報（曲名、アーティスト、開始時間、終了時間）
  - リストからの直接ジャンプ機能
  - 再生順序表示

- **曲間遷移の視覚化**
  - 曲と曲の切り替わりポイントの視覚的表示
  - クロスフェードやトランジションの視覚的表現（可能であれば）

## 3. データ要件

### 3.1 楽曲アノテーションデータ構造
- **楽曲セクション定義**
  - 各楽曲セクションは以下の情報を含む：
    - 一意のID
    - 曲名
    - アーティスト名
    - 開始時間（秒単位）
    - 終了時間（秒単位）
    - 表示色（CSSカラーコード）
    - ジャンル（オプション）
    - 追加情報（原曲へのリンクなど、オプション）

- **コード進行データ** [オプション]
  - 各コードセクションの情報：
    - コード名（例：Em7, Bm7, etc）
    - 開始時間
    - 終了時間
    - 表示色

- **データ保存形式**
  - JSONファイルまたはデータベースに格納
  - 動画IDと楽曲情報の関連付け

### 3.2 データモデル例

```typescript
// 楽曲セクションのデータモデル
type SongSection = {
  id: number;
  title: string;        // 曲名
  artist: string;       // アーティスト名
  startTime: number;    // 開始時間（秒）
  endTime: number;      // 終了時間（秒）
  color: string;        // 表示色（CSS color code）
  genre?: string;       // ジャンル（オプション）
  originalLink?: string; // 原曲へのリンク（オプション）
};

// コード進行のデータモデル
type ChordSection = {
  id: number;
  chord: string;        // コード名
  startTime: number;    // 開始時間（秒）
  endTime: number;      // 終了時間（秒）
  color: string;        // 表示色
};

// メドレー情報全体のデータモデル
type MedleyData = {
  videoId: string;      // 動画ID
  title: string;        // メドレータイトル
  creator?: string;     // 制作者
  duration: number;     // 総再生時間（秒）
  songs: SongSection[]; // 楽曲セクション配列
  chords?: ChordSection[]; // コード進行配列（オプション）
};
```

## 4. ユーザーインターフェース要件

### 4.1 レイアウト構成
- **ヘッダー領域**
  - タイトル表示
  - 動画ID入力フォーム
  - 設定メニュー（オプション）

- **プレイヤー領域**
  - 埋め込みプレイヤー表示
  - 再生状態インジケータ

- **コントロールバー**
  - 再生/一時停止ボタン
  - シークバー
  - 音量コントロール
  - 時間表示
  - フルスクリーンボタン

- **楽曲タイムライン領域**
  - 楽曲セクションタイムライン表示
  - 現在位置インジケーター
  - 楽曲情報表示

- **楽曲リスト領域**
  - メドレー内の全楽曲リスト
  - 各楽曲の時間情報
  - ジャンプボタン

### 4.2 デザイン要件
- ニコニコ動画のデザイン言語と調和するUI
- 音楽視覚化に適したカラースキーム
- 直感的で使いやすいインターフェース
- モバイル対応レスポンシブデザイン

## 5. ニコニコ動画プレイヤーAPI統合

### 5.1 プレイヤー初期化
- 埋め込みURLパラメータ：`https://embed.nicovideo.jp/watch/{videoId}?jsapi=1&playerId=1`
- iframe要素の適切な設定
- プレイヤー読み込み完了イベントのハンドリング

### 5.2 プレイヤー制御API
- **postMessage**を使用した通信
  - 再生/一時停止コマンド
  - シーク操作
  - 音量調整
  - 状態取得

### 5.3 イベントハンドリング
- プレイヤーイベントのリスニング（loadComplete, playerMetadataChange, statusChange等）
- イベントに基づくUI更新
- エラー処理とリカバリー

## 6. 将来的な拡張可能性

### 6.1 追加機能候補
- **楽曲メタデータの拡充**
  - 外部音楽データベースとの連携
  - 原曲情報の表示と原曲へのリンク

- **コミュニティ機能**
  - ユーザーによる楽曲アノテーションの投稿・編集
  - お気に入りタイムスタンプの保存

- **分析ツール**
  - メドレー内の楽曲分布の可視化
  - ジャンル分析
  - 楽曲構成の分析

- **プレイリスト機能**
  - 同じ曲が含まれる他のメドレーへのリンク
  - カスタムプレイリストの作成

## 7. 制約条件

### 7.1 技術的制約
- ニコニコ動画埋め込みプレイヤーAPIの制限に準拠
- クロスオリジンポリシーへの対応
- iframeベースの制御方法の制限

### 7.2 パフォーマンス要件
- 大量の楽曲アノテーションがある場合でもスムーズに動作
- シークバーと楽曲タイムラインの高速レスポンス
- スムーズな再生制御と楽曲切り替え

## 8. 実装プラン

### 8.1 開発フェーズ
1. **基本プレイヤー機能実装**
   - ニコニコ動画プレイヤーの埋め込みと基本制御
   - 再生/一時停止、シーク、音量制御の実装

2. **楽曲タイムライン機能実装**
   - タイムライン表示コンポーネントの開発
   - 楽曲セクションの視覚化

3. **データ連携機能実装**
   - 楽曲データの読み込みと処理
   - プレイヤー状態と楽曲データの連携

4. **UI/UX改善**
   - インターフェース全体の最適化
   - レスポンシブデザインの適用
   - パフォーマンス調整

### 8.2 テスト計画
- 各種ブラウザでの動作確認
- 様々な長さと複雑さのメドレーでのテスト
- ユーザビリティテスト

## 9. 付録

### 9.1 サンプルデータ

```json
{
  "videoId": "sm12345",
  "title": "ボカロメドレー2025",
  "creator": "メドレー製作者",
  "duration": 600,
  "songs": [
    {
      "id": 1,
      "title": "千本桜",
      "artist": "黒うさP",
      "startTime": 0,
      "endTime": 90,
      "color": "#ff7979",
      "genre": "ボカロ"
    },
    {
      "id": 2,
      "title": "マトリョシカ",
      "artist": "ハチ",
      "startTime": 90,
      "endTime": 175,
      "color": "#7ed6df",
      "genre": "ボカロ"
    },
    {
      "id": 3,
      "title": "メルト",
      "artist": "ryo",
      "startTime": 175,
      "endTime": 265,
      "color": "#f6e58d",
      "genre": "ボカロ"
    }
  ],
  "chords": [
    {"id": 1, "chord": "Em", "startTime": 0, "endTime": 15, "color": "#dff9fb"},
    {"id": 2, "chord": "C", "startTime": 15, "endTime": 30, "color": "#f9ca24"},
    {"id": 3, "chord": "G", "startTime": 30, "endTime": 45, "color": "#badc58"}
  ]
}
```

### 9.2 参考リソース
- [ニコニコ動画 埋め込みプレイヤー公式情報](https://site.nicovideo.jp/doga-support/about/common/player/embed.html)
- [iframe API一般情報](https://developer.mozilla.org/ja/docs/Web/API/Window/postMessage)
